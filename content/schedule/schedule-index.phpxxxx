




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script>
res = "";

   function step2()
        {
     
var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
    res = this.responseText.substring(5, 11);
    if((res[0]!=1&&0)||(res[1]!=1&&0)||(res[2]!=1&&0)||(res[3]!=1&&0)||(res[4]!=1&&0)||(res[5]!=1&&0))
        {
            //(res[0]!=1&&0)||(res[1]!=1&&0)||(res[2]!=1&&0)||(res[3]!=1&&0)||(res[4]!=1&&0)||(res[5]!=1&&0)||)
         console.log(res[0]);
         console.log('error in input info');
         loadInfo();
        }
        else
        {
         console.log('good input info');
        loadDoc();
        }
     
    }
  };
  xhttp.open("POST", "../../get_info.php", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.send('');  
  
}



        

function loadInfo() {

  
   var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
     
     step2();
    }
  };
  xhttp.open("POST", "../../commands2.php", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.send("command=info");  
  
}



function loadDoc() {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        schedule_array = JSON.parse(this.responseText);
     console.log(this.responseText);
     startControl(schedule_array);
    }
  };
  xhttp.open("POST", "schedule-data.php", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.send("");
}
function startControl(schedule_array)
{
    var current_date = new Date();
    var current_hour = current_date.getHours();
    console.log(schedule_array['element'].length);
    var number_of_elements = schedule_array['element'].length;
    for(loop=0;loop!=number_of_elements;loop++)
    {
        //console.log(schedule_array['active'][loop]);
        if(schedule_array['active'][loop]==1) // if active is on 
        {
                            var need_to_be_on =false; 
                    var start_time =schedule_array['hour_start'][loop];
                    var end_time =  schedule_array['hour_end'][loop];
                    for(loop2=start_time;loop2!=end_time;loop2++)
                        {
                            if (loop2==current_hour)
                            {
                                
                                switch (schedule_array['element'][loop]) 
                                {
                                    case 'light':
                                                console.log('090909');
                                            if(res[0]==1)
                                            {
                                                console.log('turn on light');
                                                sendCommand("light");
                                            }
                                        break;
                                    
                                    case 'empty':
                                                console.log(res+'  empty');
                                            if(res[1]==1)
                                            {
                                                console.log('turn on empty');
                                                debugger;
                                                sendCommand("empty");
                                            }
                                        break;

                                    case 'skimmer':
                                        if(res[2]==1)
                                            {
                                                console.log('turn on ski');
                                                sendCommand("skimmer");
                                            }
                                        break;

                                    case 'fan':
                                            if(res[3]==1)
                                            {
                                                console.log('turn on fan');
                                                sendCommand("fan");
                                            }
                                        break;

                                    case 'upload':
                                            if(res[4]==1)
                                            {
                                                console.log('turn on up');
                                                sendCommand("upload");
                                            }
                                        break;

                                    case 'wave':
                                            if(res[5]==1)
                                            {
                                                console.log('turn on wave');
                                                sendCommand("wave");
                                            }
                                        break;


                                }


                                //console.log('start light');
                                need_to_be_on= true;
                                break; // if its true you can get off the loop
                            }
                            //else{console.log('llllll')}

                            if (loop2 == 23)loop2=-1;
                        
                        }// end of time loop
                    if(need_to_be_on== false)
                    {
                         
                                switch (schedule_array['element'][loop]) 
                                {
                                    case 'light':
                                            if(res[0]==0)
                                            {
                                                console.log('turn off light');
                                                sendCommand("light");
                                            }
                                        break;
                                    
                                    case 'empty':
                                            if(res[1]==0)
                                            {
                                                console.log('turn off empty');
                                                sendCommand("empty");
                                            }
                                        break;

                                    case 'skimmer':
                                        if(res[2]==0)
                                            {
                                                console.log('turn off skimmer');
                                                sendCommand("skimmer");
                                            }
                                        break;

                                    case 'fan':
                                            if(res[3]==1)
                                            {
                                                console.log('turn off fan');
                                                sendCommand("fan");
                                            }
                                        break;

                                    case 'upload':
                                            if(res[4]==1)
                                            {
                                                console.log('turn off upload');
                                                sendCommand("upload");
                                            }
                                        break;

                                    case 'wave':
                                            if(res[5]==1)
                                            {
                                                console.log('turn off wave');
                                                sendCommand("wave");
                                            }
                                        break;


                                }
                    }

        }
    }
}
function sendCommand(command)
{
  var params = "command="+command;
   var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
        console.log(this.responseText);
    }
  };
  xhttp.open("POST", "../../commands.php", true);
    xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
  xhttp.send(params);  


}
loadInfo();


</script>
</head>
<body>
    <div id="demo"></div>
</body>
</html>
